import injector
from pydantic import BaseModel

from quart import Blueprint, render_template
from quart_schema import validate_response, document_headers

from watson_extension.core.insights.vulnerability import (
    VulnerabilityCore,
)
from watson_extension.routes import RHSessionIdHeader

blueprint = Blueprint("vulnerability", __name__, url_prefix="/vulnerability")


class CVEsResponse(BaseModel):
    response: str


@blueprint.get("/cves")
@validate_response(CVEsResponse)
@document_headers(RHSessionIdHeader)
async def cves(
    vulnerability_service: injector.Inject[VulnerabilityCore],
) -> CVEsResponse:
    vulnerability_limit = 5
    cves_response = await vulnerability_service.get_cves(vulnerability_limit)

    return CVEsResponse(
        response=await render_template(
            "insights/vulnerability/vulnerability.txt.jinja",
            vulnerability_limit=vulnerability_limit,
            cves=cves_response,
            dashboard_link="/insights/vulnerability/cves",
        )
    )
